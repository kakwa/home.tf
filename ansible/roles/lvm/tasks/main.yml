---
- name: Check if LVM is enabled
  fail:
    msg: |
      LVM role is disabled by default for safety.
      To enable LVM operations, set 'lvm_enable: true' in your playbook or inventory.
      WARNING: LVM operations can be destructive and will wipe data on configured devices!
  when: not lvm_enable | bool

# Install required packages
- name: Install LVM and RAID tools
  package:
    name:
      - lvm2
      - mdadm
    state: present
  when: lvm_enable | bool

# Rescan device mapper and LVM to detect existing setups
- name: Scan for LVM physical volumes
  command: pvscan
  changed_when: false
  when: lvm_enable | bool

- name: Scan for LVM volume groups
  command: vgscan
  changed_when: false
  when: lvm_enable | bool

- name: Activate all volume groups
  command: vgchange -ay
  changed_when: false
  when: lvm_enable | bool

# Fast pool setup (RAID 5)
- name: Check if fast pool devices exist
  stat:
    path: "{{ item }}"
  register: fast_pool_devices_stat
  loop: "{{ lvm_fast_pool_devices }}"
  when: lvm_enable | bool

- name: Display fast pool devices status
  debug:
    msg: "Device {{ item.item }} {{ 'exists' if item.stat.exists else 'does not exist' }}"
  loop: "{{ fast_pool_devices_stat.results }}"
  when: lvm_enable | bool

- name: Check if fast pool volume group exists
  command: "vgs {{ lvm_fast_pool_vg_name }}"
  register: fast_pool_vg_check
  failed_when: false
  changed_when: false
  when: lvm_enable | bool

- name: Force remove fast pool if recreation requested
  block:
    - name: Unmount fast pool if mounted
      mount:
        path: "{{ lvm_fast_pool_mount_point }}"
        state: absent
      failed_when: false

    - name: Remove fast pool logical volume
      lvol:
        vg: "{{ lvm_fast_pool_vg_name }}"
        lv: "{{ lvm_fast_pool_lv_name }}"
        state: absent
        force: yes
      failed_when: false

    - name: Remove fast pool volume group
      lvg:
        vg: "{{ lvm_fast_pool_vg_name }}"
        state: absent
        force: yes
      failed_when: false

    - name: Stop RAID array for fast pool
      command: "mdadm --stop /dev/md/fast-pool"
      failed_when: false
      ignore_errors: yes

    - name: Stop any other RAID arrays on fast pool devices
      shell: |
        for dev in {{ lvm_fast_pool_devices | join(' ') }}; do
          # Find any RAID arrays using this device
          md_devices=$(grep -l "$dev" /sys/block/md*/md/dev-*/block/*/uevent 2>/dev/null | cut -d/ -f4 | sort -u || true)
          for md in $md_devices; do
            echo "Stopping /dev/$md"
            mdadm --stop /dev/$md 2>/dev/null || true
          done
        done
      failed_when: false
      ignore_errors: yes

  when:
    - lvm_enable | bool
    - lvm_force_recreate | bool
    - fast_pool_vg_check.rc == 0

- name: Create RAID 1 array for fast pool
  block:
    - name: Thorough wipe of fast pool devices
      block:
        - name: Zero RAID superblocks on fast pool devices
          command: "mdadm --zero-superblock {{ item }}"
          loop: "{{ lvm_fast_pool_devices }}"
          failed_when: false
          ignore_errors: yes

        - name: Check for signatures on fast pool devices
          command: "wipefs -n {{ item }}"
          loop: "{{ lvm_fast_pool_devices }}"
          register: fast_pool_signatures
          failed_when: false
          changed_when: false

        - name: Display signatures found on fast pool devices
          debug:
            msg: "{{ item.stdout }}"
          loop: "{{ fast_pool_signatures.results }}"
          when: item.stdout != ""

        - name: Wipe all signatures on fast pool devices
          command: "wipefs -af {{ item }}"
          loop: "{{ lvm_fast_pool_devices }}"

      when:
        - lvm_wipe_signatures | bool
        - (fast_pool_vg_check.rc != 0 or lvm_force_recreate | bool)

    - name: Create RAID 1 array
      command: >
        mdadm --create /dev/md/fast-pool
        --level={{ lvm_fast_pool_raid_level }}
        --raid-devices={{ lvm_fast_pool_devices | length }}
        {{ lvm_fast_pool_devices | join(' ') }}
        --bitmap=internal
        --force
        --run
      args:
        creates: /dev/md/fast-pool
      register: raid_created

    - name: Wait for RAID array to be available
      wait_for:
        path: /dev/md/fast-pool
        state: present
        timeout: 30

    - name: Save RAID configuration
      shell: "mdadm --detail --scan >> /etc/mdadm/mdadm.conf"
      args:
        creates: /etc/mdadm/mdadm.conf
      ignore_errors: yes
      register: mdadm_conf_updated

    - name: Update initramfs
      command: update-initramfs -u
      when:
        - ansible_os_family == "Debian"
        - raid_created is changed or mdadm_conf_updated is changed
      ignore_errors: yes

    - name: Create physical volume on RAID array
      lvg:
        pvs: /dev/md/fast-pool
        vg: "{{ lvm_fast_pool_vg_name }}"
        state: present
      when: fast_pool_vg_check.rc != 0

    - name: Create logical volume for fast pool
      lvol:
        vg: "{{ lvm_fast_pool_vg_name }}"
        lv: "{{ lvm_fast_pool_lv_name }}"
        size: "{{ lvm_fast_pool_lv_size }}"
        shrink: no
        resizefs: yes
        state: present

    - name: Create filesystem on fast pool logical volume
      filesystem:
        fstype: "{{ lvm_fast_pool_filesystem }}"
        dev: "/dev/{{ lvm_fast_pool_vg_name }}/{{ lvm_fast_pool_lv_name }}"
        force: no

    - name: Create fast pool mount point
      file:
        path: "{{ lvm_fast_pool_mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount fast pool
      mount:
        path: "{{ lvm_fast_pool_mount_point }}"
        src: "/dev/{{ lvm_fast_pool_vg_name }}/{{ lvm_fast_pool_lv_name }}"
        fstype: "{{ lvm_fast_pool_filesystem }}"
        opts: "{{ lvm_mount_options }}"
        state: mounted

  when:
    - lvm_enable | bool
    - fast_pool_devices_stat.results | selectattr('stat.exists') | list | length == lvm_fast_pool_devices | length

# Slow pool setup (single disk)
- name: Check if slow pool devices exist
  stat:
    path: "{{ item }}"
  register: slow_pool_devices_stat
  loop: "{{ lvm_slow_pool_devices }}"
  when: lvm_enable | bool

- name: Display slow pool devices status
  debug:
    msg: "Device {{ item.item }} {{ 'exists' if item.stat.exists else 'does not exist' }}"
  loop: "{{ slow_pool_devices_stat.results }}"
  when: lvm_enable | bool

- name: Check if slow pool volume group exists
  command: "vgs {{ lvm_slow_pool_vg_name }}"
  register: slow_pool_vg_check
  failed_when: false
  changed_when: false
  when: lvm_enable | bool

- name: Force remove slow pool if recreation requested
  block:
    - name: Unmount slow pool if mounted
      mount:
        path: "{{ lvm_slow_pool_mount_point }}"
        state: absent
      failed_when: false

    - name: Remove slow pool logical volume
      lvol:
        vg: "{{ lvm_slow_pool_vg_name }}"
        lv: "{{ lvm_slow_pool_lv_name }}"
        state: absent
        force: yes
      failed_when: false

    - name: Remove slow pool volume group
      lvg:
        vg: "{{ lvm_slow_pool_vg_name }}"
        state: absent
        force: yes
      failed_when: false

  when:
    - lvm_enable | bool
    - lvm_force_recreate | bool
    - slow_pool_vg_check.rc == 0

- name: Create slow pool LVM setup
  block:
    - name: Thorough wipe of slow pool devices
      block:
        - name: Zero any RAID superblocks on slow pool devices
          command: "mdadm --zero-superblock {{ item }}"
          loop: "{{ lvm_slow_pool_devices }}"
          failed_when: false
          ignore_errors: yes

        - name: Check for signatures on slow pool devices
          command: "wipefs -n {{ item }}"
          loop: "{{ lvm_slow_pool_devices }}"
          register: slow_pool_signatures
          failed_when: false
          changed_when: false

        - name: Display signatures found on slow pool devices
          debug:
            msg: "{{ item.stdout }}"
          loop: "{{ slow_pool_signatures.results }}"
          when: item.stdout != ""

        - name: Wipe all signatures on slow pool devices
          command: "wipefs -af {{ item }}"
          loop: "{{ lvm_slow_pool_devices }}"

      when:
        - lvm_wipe_signatures | bool
        - (slow_pool_vg_check.rc != 0 or lvm_force_recreate | bool)

    - name: Create physical volume for slow pool
      lvg:
        pvs: "{{ lvm_slow_pool_devices | join(',') }}"
        vg: "{{ lvm_slow_pool_vg_name }}"
        state: present
      when: slow_pool_vg_check.rc != 0

    - name: Create logical volume for slow pool
      lvol:
        vg: "{{ lvm_slow_pool_vg_name }}"
        lv: "{{ lvm_slow_pool_lv_name }}"
        size: "{{ lvm_slow_pool_lv_size }}"
        shrink: no
        resizefs: yes
        state: present

    - name: Create filesystem on slow pool logical volume
      filesystem:
        fstype: "{{ lvm_slow_pool_filesystem }}"
        dev: "/dev/{{ lvm_slow_pool_vg_name }}/{{ lvm_slow_pool_lv_name }}"
        force: no

    - name: Create slow pool mount point
      file:
        path: "{{ lvm_slow_pool_mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount slow pool
      mount:
        path: "{{ lvm_slow_pool_mount_point }}"
        src: "/dev/{{ lvm_slow_pool_vg_name }}/{{ lvm_slow_pool_lv_name }}"
        fstype: "{{ lvm_slow_pool_filesystem }}"
        opts: "{{ lvm_mount_options }}"
        state: mounted

  when:
    - lvm_enable | bool
    - slow_pool_devices_stat.results | selectattr('stat.exists') | list | length == lvm_slow_pool_devices | length

# Mid pool setup (just a directory)
- name: Create mid pool directory
  file:
    path: "{{ lvm_mid_pool_directory }}"
    state: directory
    mode: '0755'
  when: lvm_enable | bool

- name: Display configuration summary
  debug:
    msg:
      - "LVM Configuration Summary:"
      - "Fast Pool: {{ lvm_fast_pool_mount_point }} (RAID {{ lvm_fast_pool_raid_level }} on {{ lvm_fast_pool_devices | length }} disks)"
      - "Slow Pool: {{ lvm_slow_pool_mount_point }} (on {{ lvm_slow_pool_devices | join(', ') }})"
      - "Mid Pool: {{ lvm_mid_pool_directory }} (directory only)"
  when: lvm_enable | bool
