---
- name: Gather package facts
  package_facts:
    manager: auto

- name: Set slapd debconf selections (domain and org)
  debconf:
    name: slapd
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.vtype | default('string') }}"
  loop:
    - { question: "slapd/internal/generated_adminpw", value: "{{ openldap_admin_password }}", vtype: "password" }
    - { question: "slapd/internal/adminpw", value: "{{ openldap_admin_password }}", vtype: "password" }
    - { question: "slapd/password1", value: "{{ openldap_admin_password }}", vtype: "password" }
    - { question: "slapd/password2", value: "{{ openldap_admin_password }}", vtype: "password" }
    - { question: "slapd/domain", value: "{{ openldap_domain }}" }
    - { question: "shared/organization", value: "{{ openldap_organization }}" }
    - { question: "slapd/backend", value: "MDB" }
    - { question: "slapd/no_install_ldap_config", value: "false", vtype: "boolean" }
    - { question: "slapd/purge_database", value: "false", vtype: "boolean" }
    - { question: "slapd/move_old_database", value: "true", vtype: "boolean" }
    - { question: "slapd/allow_ldap_v2", value: "false", vtype: "boolean" }
  when: "'slapd' not in ansible_facts.packages"

- name: Install OpenLDAP server and utilities
  apt:
    name:
      - slapd
      - ldap-utils
      - gnutls-bin
    state: present
    update_cache: true
  when: "'slapd' not in ansible_facts.packages"

- name: Create OpenLDAP SSL directory
  file:
    path: "{{ openldap_ssl_dir }}"
    state: directory
    mode: "0750"
    owner: root
    group: openldap

- name: Create OpenLDAP LDIF directory
  file:
    path: "{{ openldap_ldif_dir }}"
    state: directory
    mode: "0750"
    owner: root
    group: openldap

- name: Generate CA key
  openssl_privatekey:
    path: "{{ openldap_ssl_dir }}/ca.key"
    owner: root
    group: openldap
    mode: "0640"
  register: openldap_ca_key

- name: Generate self-signed CA certificate (openssl CLI)
  command: >
    openssl req -new -x509 -days 3650
    -key {{ openldap_ssl_dir }}/ca.key -out {{ openldap_ssl_dir }}/ca.crt
    -subj "/O={{ openldap_organization }}/CN=Kakwa Lab LDAP CA"
  args:
    creates: "{{ openldap_ssl_dir }}/ca.crt"

- name: Generate LDAP server key
  openssl_privatekey:
    path: "{{ openldap_ssl_dir }}/ldap.key"
    owner: openldap
    group: openldap
    mode: "0640"

- name: Generate LDAP server certificate signing request
  command: >
    openssl req -new -key {{ openldap_ssl_dir }}/ldap.key -out {{ openldap_ssl_dir }}/ldap.csr
    -subj "/O={{ openldap_organization }}/CN={{ openldap_fqdn }}"
    -addext "subjectAltName=DNS:{{ openldap_fqdn }},DNS:utility,DNS:localhost"
  args:
    creates: "{{ openldap_ssl_dir }}/ldap.csr"

- name: Sign LDAP server certificate with CA
  command: >
    openssl x509 -req -in {{ openldap_ssl_dir }}/ldap.csr
    -CA {{ openldap_ssl_dir }}/ca.crt -CAkey {{ openldap_ssl_dir }}/ca.key
    -CAcreateserial -out {{ openldap_ssl_dir }}/ldap.crt -days 3650
  args:
    creates: "{{ openldap_ssl_dir }}/ldap.crt"

- name: Set ownership on LDAP server certificate and key
  file:
    path: "{{ item }}"
    owner: openldap
    group: openldap
    mode: "0640"
  loop:
    - "{{ openldap_ssl_dir }}/ldap.crt"
    - "{{ openldap_ssl_dir }}/ldap.key"

- name: Create LDIF for TLS configuration (cn=config)
  copy:
    content: |
      dn: cn=config
      changetype: modify
      replace: olcTLSCACertificateFile
      olcTLSCACertificateFile: {{ openldap_ca_cert }}
      -
      replace: olcTLSCertificateFile
      olcTLSCertificateFile: {{ openldap_server_cert }}
      -
      replace: olcTLSCertificateKeyFile
      olcTLSCertificateKeyFile: {{ openldap_server_key }}
      -
      replace: olcLocalSSF
      olcLocalSSF: 71
      -
      replace: olcSecurity
      olcSecurity: tls=1
    dest: "{{ openldap_ldif_dir }}/openldap-tls.ldif"
    mode: "0600"
  notify: restart slapd

- name: Configure SLAPD_SERVICES (ldap + ldaps + ldapi)
  lineinfile:
    path: /etc/default/slapd
    regexp: "^#?SLAPD_SERVICES=.*"
    line: "SLAPD_SERVICES=\"{{ openldap_services }}\""
    create: true
  notify: restart slapd

- name: Ensure slapd is started and enabled
  service:
    name: slapd
    state: started
    enabled: true

- name: Flush handlers so slapd restarts with ldapi before schema load
  meta: flush_handlers

# Load OpenSSH LPK schema *before* applying TLS config (olcSecurity/olcLocalSSF),
# otherwise ldapi EXTERNAL fails with "Confidentiality required"
- name: Load OpenSSH LPK schema (sshPublicKey) into slapd
  copy:
    src: openssh-lpk.ldif
    dest: "{{ openldap_ldif_dir }}/openssh-lpk.ldif"
    mode: "0600"
  register: openldap_schema_copy

- name: Add OpenSSH LPK schema to cn=config
  command: ldapadd -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/openssh-lpk.ldif
  register: openldap_schema_add
  failed_when: false
  changed_when: openldap_schema_add.rc == 0
  become: true

# NIS schema (posixGroup, gidNumber) is usually loaded by Debian slapd; load groupWithMember and memberOf user schema
- name: Copy groupWithMember and memberOf-user schema LDIFs
  copy:
    src: "{{ item }}"
    dest: "{{ openldap_ldif_dir }}/{{ item }}"
    mode: "0600"
  loop:
    - group-with-member.ldif
    - memberof-user.ldif
  become: true

- name: Add groupWithMember schema to cn=config
  command: ldapadd -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/group-with-member.ldif
  register: openldap_groupwithmember_add
  failed_when: false
  changed_when: openldap_groupwithmember_add.rc == 0
  become: true

- name: Add memberOf-user schema to cn=config
  command: ldapadd -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/memberof-user.ldif
  register: openldap_memberof_user_add
  failed_when: false
  changed_when: openldap_memberof_user_add.rc == 0
  become: true

# cn=config is only reachable via ldapi EXTERNAL; LDAPS with cn=admin cannot query it (No such object).
# When ldapi fails with "Confidentiality required" (rc 13) after TLS is applied, use default MDB DN.
- name: Get MDB database DN from cn=config (ldapi)
  command: ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=config -LLL "(olcDatabase=*mdb*)" dn
  register: openldap_mdb_search
  become: true
  changed_when: false
  failed_when: openldap_mdb_search.rc != 0 and openldap_mdb_search.rc != 13

- name: Set OpenLDAP MDB database DN for overlay
  set_fact:
    openldap_mdb_dn: "{{ ((openldap_mdb_search.stdout | regex_findall('dn:\\s*(.+)')) + ['olcDatabase={1}mdb,cn=config'])[0] if openldap_mdb_search.rc == 0 else 'olcDatabase={1}mdb,cn=config' }}"

- name: Create memberof overlay LDIF
  copy:
    content: |
      dn: olcOverlay=memberof,{{ openldap_mdb_dn }}
      objectClass: olcOverlayConfig
      objectClass: olcMemberOf
      olcOverlay: memberof
      olcMemberOfGroupOC: posixGroup
      olcMemberOfMemberAD: member
      olcMemberOfMemberOfAD: memberOf
      olcMemberOfRefInt: "TRUE"
      olcMemberOfDangling: ignore
    dest: "{{ openldap_ldif_dir }}/memberof-overlay.ldif"
    mode: "0600"
  become: true

- name: Add memberof overlay to MDB database
  command: ldapadd -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/memberof-overlay.ldif
  register: openldap_memberof_overlay_add
  failed_when: false
  changed_when: openldap_memberof_overlay_add.rc == 0
  become: true

# PPolicy overlay: recognizes password-policy control 1.3.6.1.4.1.42.2.27.8.5.1 sent by nslcd,
# so slapd stops logging "unrecognized control" and PAM/LDAP bind works without noise.
- name: Create ppolicy overlay LDIF
  copy:
    content: |
      dn: olcOverlay=ppolicy,{{ openldap_mdb_dn }}
      objectClass: olcOverlayConfig
      objectClass: olcPPolicyConfig
      olcOverlay: ppolicy
    dest: "{{ openldap_ldif_dir }}/ppolicy-overlay.ldif"
    mode: "0600"
  become: true

- name: Add ppolicy overlay to MDB database
  command: ldapadd -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/ppolicy-overlay.ldif
  register: openldap_ppolicy_overlay_add
  failed_when: false
  changed_when: openldap_ppolicy_overlay_add.rc == 0
  become: true

# ACL for ssh_ldap read-only account (must run via ldapi before TLS, else "Confidentiality required")
- name: Check if ACL for ssh_ldap read-only account already exists
  command: ldapsearch -Y EXTERNAL -H ldapi:/// -b "{{ openldap_mdb_dn }}" -LLL olcAccess
  register: openldap_acl_search
  changed_when: false
  failed_when: false
  become: true

- name: Create LDIF to add olcAccess for ssh_ldap read-only account
  copy:
    content: |
      dn: {{ openldap_mdb_dn }}
      changetype: modify
      add: olcAccess
      olcAccess: to dn.subtree="{{ openldap_base_dn }}" by dn.exact="{{ openldap_ssh_ldap_readonly_dn }}" read
    dest: "{{ openldap_ldif_dir }}/acl-ssh-ldap-readonly.ldif"
    mode: "0600"
  become: true

- name: Add ACL for ssh_ldap read-only account to MDB database (via ldapi)
  command: ldapmodify -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/acl-ssh-ldap-readonly.ldif
  register: openldap_acl_add_ldapi
  become: true
  when: openldap_ssh_ldap_readonly_dn not in (openldap_acl_search.stdout | default(''))
  failed_when: openldap_acl_add_ldapi.rc is defined and openldap_acl_add_ldapi.rc != 0 and openldap_acl_add_ldapi.rc != 13

- name: Apply TLS configuration to slapd (ldapi EXTERNAL)
  command: ldapmodify -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/openldap-tls.ldif
  register: openldap_tls_apply
  changed_when: openldap_tls_apply.rc == 0
  failed_when: false
  become: true

- name: Add olcLocalSSF via LDAPS (recover when ldapi requires confidentiality)
  copy:
    content: |
      dn: cn=config
      changetype: modify
      replace: olcLocalSSF
      olcLocalSSF: 71
    dest: "{{ openldap_ldif_dir }}/openldap-localssf.ldif"
    mode: "0600"
  when: openldap_tls_apply.rc != 0

- name: Flush handlers so slapd restarts with ldaps before OU/group creation
  meta: flush_handlers

- name: Get existing OUs under base DN
  community.general.ldap_search:
    dn: "{{ openldap_base_dn }}"
    scope: "onelevel"
    filter: "(objectClass=organizationalUnit)"
    attrs: ["ou"]
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  register: openldap_existing_ous
  failed_when: false
  changed_when: false

- name: Create base OUs (people, groups) in LDAP
  community.general.ldap_entry:
    dn: "ou={{ item.ou }},{{ openldap_base_dn }}"
    objectClass: organizationalUnit
    attributes:
      ou: "{{ item.ou }}"
    state: present
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  loop:
    - { ou: "people" }
    - { ou: "groups" }
    - { ou: "services" }
  when: item.ou not in (openldap_existing_ous.results | default([]) | map(attribute='ou') | flatten | list)
  ignore_errors: true
  register: openldap_ou_result
  changed_when: openldap_ou_result is not failed

- name: Create default groups cn=users and cn=admins for ldapcherry (posixGroup + GIDs)
  community.general.ldap_entry:
    dn: "cn={{ item }},ou=groups,{{ openldap_base_dn }}"
    objectClass:
      - posixGroup
      - groupWithMember
    attributes:
      cn: "{{ item }}"
      gidNumber: "{{ openldap_group_gids[item] | string }}"
      member: ["cn=admin,{{ openldap_base_dn }}"]
    state: present
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  loop:
    - users
    - admins
  ignore_errors: true
  register: openldap_default_groups_result

- name: Create groups ssh-admins, k8s-admins, ssh-users, k8s-users (posixGroup + GIDs, ldapcherry + SSH/sudo)
  community.general.ldap_entry:
    dn: "cn={{ item }},ou=groups,{{ openldap_base_dn }}"
    objectClass:
      - posixGroup
      - groupWithMember
    attributes:
      cn: "{{ item }}"
      gidNumber: "{{ openldap_group_gids[item] | string }}"
      member: ["cn=admin,{{ openldap_base_dn }}"]
    state: present
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  loop: "{{ openldap_role_groups }}"
  ignore_errors: true
  register: openldap_role_groups_result

# Read-only technical account for ssh_ldap (NSS/PAM/AuthorizedKeysCommand)
- name: Hash password for ssh_ldap read-only technical account
  command: slappasswd -s "{{ openldap_ssh_ldap_readonly_password }}"
  register: openldap_ssh_ldap_readonly_password_hash
  changed_when: false
  become: true

- name: Create ssh_ldap read-only technical account in ou=services
  community.general.ldap_entry:
    dn: "{{ openldap_ssh_ldap_readonly_dn }}"
    objectClass:
      - inetOrgPerson
      - organizationalPerson
      - person
      - top
    attributes:
      uid: "{{ openldap_ssh_ldap_readonly_uid }}"
      cn: "{{ openldap_ssh_ldap_readonly_uid }}"
      sn: "{{ openldap_ssh_ldap_readonly_uid }}"
      userPassword: "{{ openldap_ssh_ldap_readonly_password_hash.stdout }}"
    state: present
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false

# Optional: create default user (carpenti) in ou=people and add to cn=users + cn=admins (only if user does not exist)
- name: Check if default user (carpenti) exists in LDAP
  community.general.ldap_search:
    dn: "ou=people,{{ openldap_base_dn }}"
    filter: "(uid={{ openldap_default_user_uid }})"
    scope: "onelevel"
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  register: openldap_default_user_search
  when: openldap_default_user_create | default(false) | bool

- name: Hash password for default user (carpenti)
  command: slappasswd -s "{{ openldap_default_user_password }}"
  register: openldap_default_user_password_hash
  changed_when: false
  when: openldap_default_user_create | default(false) | bool and (openldap_default_user_search.results | default([]) | length == 0)

- name: Create default user (carpenti) in ou=people (if missing)
  community.general.ldap_entry:
    dn: "uid={{ openldap_default_user_uid }},ou=people,{{ openldap_base_dn }}"
    objectClass:
      - top
      - person
      - organizationalPerson
      - inetOrgPerson
      - posixAccount
      - userWithMemberOf
    attributes:
      uid: "{{ openldap_default_user_uid }}"
      cn: "{{ openldap_default_user_cn }}"
      sn: "{{ openldap_default_user_sn }}"
      uidNumber: "{{ openldap_default_user_uid_number | string }}"
      gidNumber: "{{ openldap_default_user_gid_number | string }}"
      homeDirectory: "{{ openldap_default_user_home }}"
      loginShell: "{{ openldap_default_user_shell }}"
      userPassword: "{{ openldap_default_user_password_hash.stdout }}"
    state: present
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  register: openldap_default_user_created
  when: openldap_default_user_create | default(false) | bool and (openldap_default_user_search.results | default([]) | length == 0)

- name: Deploy LDIF to add sshPublicKey to default user
  template:
    src: add-ssh-key.ldif.j2
    dest: "{{ openldap_ldif_dir }}/add-ssh-key-{{ openldap_default_user_uid }}.ldif"
    mode: "0600"
  when: >
    openldap_default_user_create | default(false) | bool
    and (openldap_default_user_ssh_public_keys | default([]) | length > 0)
    and ((openldap_default_user_search.results | default([]) | length > 0)
         or (openldap_default_user_created is defined and openldap_default_user_created is changed))

- name: Add SSH public keys to default user via ldapi (OpenSSH LPK schema)
  command: ldapmodify -Y EXTERNAL -H ldapi:/// -f {{ openldap_ldif_dir }}/add-ssh-key-{{ openldap_default_user_uid }}.ldif
  register: openldap_default_user_ssh_add
  failed_when: false
  changed_when: openldap_default_user_ssh_add.rc == 0
  become: true
  when: >
    openldap_default_user_create | default(false) | bool
    and (openldap_default_user_ssh_public_keys | default([]) | length > 0)
    and ((openldap_default_user_search.results | default([]) | length > 0)
         or (openldap_default_user_created is defined and openldap_default_user_created is changed))

- name: Add SSH public keys to default user via LDAPS (ensure key present)
  community.general.ldap_attrs:
    dn: "uid={{ openldap_default_user_uid }},ou=people,{{ openldap_base_dn }}"
    state: present
    attributes:
      objectClass: ["ldapPublicKey"]
      sshPublicKey: "{{ openldap_default_user_ssh_public_keys }}"
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  when: >
    openldap_default_user_create | default(false) | bool
    and (openldap_default_user_ssh_public_keys | default([]) | length > 0)
    and ((openldap_default_user_search.results | default([]) | length > 0)
         or (openldap_default_user_created is defined and openldap_default_user_created is changed))
  register: openldap_default_user_ssh_ldaps
  failed_when: false
  changed_when: openldap_default_user_ssh_ldaps is not failed

- name: Add default user (carpenti) to group cn=users
  community.general.ldap_attrs:
    dn: "cn=users,ou=groups,{{ openldap_base_dn }}"
    state: present
    attributes:
      member: ["cn=admin,{{ openldap_base_dn }}", "uid={{ openldap_default_user_uid }},ou=people,{{ openldap_base_dn }}"]
      memberUid: ["{{ openldap_default_user_uid }}"]
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  when: >
    openldap_default_user_create | default(false) | bool
    and ((openldap_default_user_search.results | default([]) | length > 0)
         or (openldap_default_user_created is defined and openldap_default_user_created is changed))

- name: Add default user (carpenti) to group cn=admins
  community.general.ldap_attrs:
    dn: "cn=admins,ou=groups,{{ openldap_base_dn }}"
    state: present
    attributes:
      member: ["cn=admin,{{ openldap_base_dn }}", "uid={{ openldap_default_user_uid }},ou=people,{{ openldap_base_dn }}"]
      memberUid: ["{{ openldap_default_user_uid }}"]
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  when: >
    openldap_default_user_create | default(false) | bool
    and ((openldap_default_user_search.results | default([]) | length > 0)
         or (openldap_default_user_created is defined and openldap_default_user_created is changed))

- name: Add default user (carpenti) to groups ssh-admins and ssh-users (SSH access)
  community.general.ldap_attrs:
    dn: "cn={{ item }},ou=groups,{{ openldap_base_dn }}"
    state: present
    attributes:
      member: ["cn=admin,{{ openldap_base_dn }}", "uid={{ openldap_default_user_uid }},ou=people,{{ openldap_base_dn }}"]
      memberUid: ["{{ openldap_default_user_uid }}"]
    server_uri: "ldaps://127.0.0.1:636/"
    bind_dn: "cn=admin,{{ openldap_base_dn }}"
    bind_pw: "{{ openldap_admin_password }}"
    validate_certs: false
  loop:
    - ssh-admins
    - ssh-users
  when: >
    openldap_default_user_create | default(false) | bool
    and ((openldap_default_user_search.results | default([]) | length > 0)
         or (openldap_default_user_created is defined and openldap_default_user_created is changed))

# memberOf overlay only writes memberOf when the user entry has an objectClass that allows it (userWithMemberOf).
- name: Create LDIF to add userWithMemberOf to existing default user
  copy:
    content: |
      dn: uid={{ openldap_default_user_uid }},ou=people,{{ openldap_base_dn }}
      changetype: modify
      add: objectClass
      objectClass: userWithMemberOf
    dest: "{{ openldap_ldif_dir }}/memberof-add-oc.ldif"
    mode: "0600"
  when: openldap_default_user_create | default(false) | bool and (openldap_default_user_search.results | default([]) | length > 0)

- name: Ensure default user has userWithMemberOf for memberOf overlay
  command: >
    ldapmodify -H ldaps://127.0.0.1:636/ -x
    -D "cn=admin,{{ openldap_base_dn }}" -w "{{ openldap_admin_password }}"
    -f "{{ openldap_ldif_dir }}/memberof-add-oc.ldif"
  environment:
    LDAPTLS_REQCERT: "never"
  become: true
  register: openldap_memberof_oc_add
  failed_when: false
  changed_when: openldap_memberof_oc_add.rc == 0
  when: openldap_default_user_create | default(false) | bool and (openldap_default_user_search.results | default([]) | length > 0)

# Touch each group (replace cn with same value) so memberOf overlay updates memberOf on user entries.
- name: Create LDIFs to touch groups (trigger memberOf overlay)
  copy:
    content: |
      dn: cn={{ item }},ou=groups,{{ openldap_base_dn }}
      changetype: modify
      replace: cn
      cn: {{ item }}
    dest: "{{ openldap_ldif_dir }}/memberof-touch-{{ item }}.ldif"
    mode: "0600"
  loop: "{{ ['users', 'admins'] + openldap_role_groups }}"
  become: true

- name: Touch groups to refresh memberOf on user entries
  command: >
    ldapmodify -H ldaps://127.0.0.1:636/ -x
    -D "cn=admin,{{ openldap_base_dn }}" -w "{{ openldap_admin_password }}"
    -f "{{ openldap_ldif_dir }}/memberof-touch-{{ item }}.ldif"
  environment:
    LDAPTLS_REQCERT: "never"
  become: true
  loop: "{{ ['users', 'admins'] + openldap_role_groups }}"
  register: openldap_memberof_touch
  failed_when: false
  changed_when: openldap_memberof_touch.rc == 0
