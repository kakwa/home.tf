#!/bin/sh
# AuthorizedKeysCommand: output sshPublicKey from LDAP (openssh-lpk) for user $1
# Runs as root; reads {{ ssh_ldap_authorized_keys_config }}

CONFIG="{{ ssh_ldap_authorized_keys_config }}"
[ -r "$CONFIG" ] || exit 1
. "$CONFIG"

[ -n "$LDAP_URI" ] && [ -n "$LDAP_BASE" ] && [ -n "$LDAP_BIND_DN" ] && [ -n "$LDAP_BIND_PWFILE" ] && [ -n "$1" ] || exit 1
[ -r "$LDAP_BIND_PWFILE" ] || exit 1

export LDAPTLS_CACERT="${LDAP_CACERT:-}"
export LDAPTLS_REQCERT="${LDAP_REQCERT:-allow}"

# Search ou=people for uid=$1, return sshPublicKey (openssh-lpk schema)
ldapsearch -x -H "$LDAP_URI" -b "{{ ssh_ldap_user_ou }}" \
    -D "$LDAP_BIND_DN" -y "$LDAP_BIND_PWFILE" \
    -LLL -o ldif-wrap=no "(&(objectClass=ldapPublicKey)(uid=$1))" sshPublicKey 2>/dev/null | sed -n 's/^sshPublicKey: *//p'
